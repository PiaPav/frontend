import { useState, useEffect, useCallback, useMemo, memo } from 'react';
import { useParams, useNavigate } from 'react-router-dom';
import ReactFlow, {
  MiniMap,
  Controls,
  Background,
  useNodesState,
  useEdgesState,
  MarkerType,
  Panel,
} from 'reactflow';
import 'reactflow/dist/style.css';
import styles from './ProjectViewArchitecture.module.css';
import { projectsAPI } from '../../services/api';

// Memoized node content component for better performance
const NodeContent = memo(({ serviceName, methodCount }) => (
  <div className={styles.nodeContent}>
    <div className={styles.nodeName}>{serviceName}</div>
    <div className={styles.nodeInfo}>
      {methodCount} method{methodCount !== 1 ? 's' : ''}
    </div>
  </div>
));

NodeContent.displayName = 'NodeContent';

export default function ProjectViewArchitecture() {
  const { id } = useParams();
  const navigate = useNavigate();
  
  const [nodes, setNodes, onNodesChange] = useNodesState([]);
  const [edges, setEdges, onEdgesChange] = useEdgesState([]);
  
  const [requirements, setRequirements] = useState([]);
  const [endpoints, setEndpoints] = useState({});
  const [architecture, setArchitecture] = useState([]);
  const [selectedNode, setSelectedNode] = useState(null);
  const [hoveredNode, setHoveredNode] = useState(null);
  
  const [streamStatus, setStreamStatus] = useState('connecting');
  const [progress, setProgress] = useState({ total: 100, current: 0 });
  
  // –î–ª—è –∏–Ω–∫—Ä–µ–º–µ–Ω—Ç–∞–ª—å–Ω–æ–≥–æ –ø–æ—Å—Ç—Ä–æ–µ–Ω–∏—è –≥—Ä–∞—Ñ–∞
  const [serviceMap, setServiceMap] = useState(new Map());

  // –°–∏–º—É–ª—è—Ü–∏—è gRPC —Å—Ç—Ä–∏–º–∞ —Å –º–æ–∫–æ–≤—ã–º–∏ –¥–∞–Ω–Ω—ã–º–∏ (–ø–æ–∫–∞ –±—ç–∫–µ–Ω–¥ —Å–ª–æ–º–∞–Ω)
  useEffect(() => {
    if (!id) {
      setStreamStatus('error');
      console.error('No project ID provided');
      return;
    }

    let cancelled = false;
    
    const _simulateStream = async () => {
      setStreamStatus('loading');
      setProgress({ total: 100, current: 5 });
      console.log('üé≠ –ó–∞–ø—É—Å–∫ —Å–∏–º—É–ª—è—Ü–∏–∏ gRPC —Å—Ç—Ä–∏–º–∞...');
      
      // Mock data –∏–∑ grpcClient.js
      const mockData = {
        requirements: [
          'aio-pika', 'asyncpg', 'bcrypt', 'boto3', 'fastapi',
          'grpcio', 'grpcio-tools', 'pika', 'protobuf', 'pyjwt',
          'python-dotenv', 'python-multipart', 'pyyaml', 'sqlalchemy', 'uvicorn'
        ],
        endpoints: {
          'registration': 'POST /v1/auth/registration',
          'refresh': 'POST /v1/auth/refresh',
          'patch_project': 'PATCH /v1/project/{project_id}',
          'patch_account': 'PATCH /v1/account',
          'login': 'POST /v1/auth/login',
          'homepage': 'GET /v1/home',
          'get_project': 'GET /v1/project/{project_id}',
          'get_projects_list': 'GET /v1/project',
          'get_account': 'GET /v1/account',
          'delete_project': 'DELETE /v1/project/{project_id}',
          'create_project': 'POST /v1/project',
        },
        architecture: [
          { parent: 'Account.create_account', children: ['datamanager/DatabaseManager.session', 'accounts/Account', 'accounts/session.add'] },
          { parent: 'Account.get_account_by_id', children: ['datamanager/DatabaseManager.session', 'accounts/session.get', 'accounts/log.error', 'accounts/DataBaseEntityNotExists'] },
          { parent: 'Account.get_account_by_login', children: ['datamanager/DatabaseManager.session', 'accounts/session.execute', 'accounts/where', 'accounts/select', 'accounts/result.scalar_one_or_none', 'accounts/log.error', 'accounts/DataBaseEntityNotExists'] },
          { parent: 'Account.is_login_exists', children: ['datamanager/DatabaseManager.session', 'accounts/session.execute', 'accounts/where', 'accounts/select', 'accounts/result.scalar_one_or_none'] },
          { parent: 'Account.patch_account_by_id', children: ['datamanager/DatabaseManager.session', 'accounts/Account.get_account_by_id', 'accounts/items', 'accounts/patch_data.model_dump', 'accounts/setattr', 'accounts/session.flush'] },
          { parent: 'DataBaseException.__init__', children: ['base/__init__', 'base/super'] },
          { parent: 'DataBaseEntityNotExists.__init__', children: ['base/__init__', 'base/super'] },
          { parent: 'DatabaseManager.__init__', children: ['datamanager/create_async_engine', 'datamanager/async_sessionmaker'] },
          { parent: 'DatabaseManager.init_models', children: ['datamanager/self.engine.begin', 'datamanager/Base.metadata.tables.get', 'datamanager/conn.run_sync', 'datamanager/ValueError', 'datamanager/conn.run_sync', 'datamanager/Base.metadata.tables.get', 'datamanager/conn.run_sync', 'datamanager/ValueError', 'datamanager/conn.run_sync'] },
          { parent: 'DatabaseManager.session', children: ['datamanager/self.session_factory', 'datamanager/session.commit', 'datamanager/session.rollback', 'datamanager/DatabaseManager.close'] },
          { parent: 'DatabaseManager.close', children: ['datamanager/self.engine.dispose'] },
          { parent: 'init_db', children: ['datamanager/DatabaseManager.init_models'] },
          { parent: 'Project.create_project', children: ['datamanager/DatabaseManager.session', 'projects/Project', 'projects/session.add'] },
          { parent: 'Project.get_project_by_id', children: ['datamanager/DatabaseManager.session', 'projects/session.get', 'projects/log.error', 'projects/DataBaseEntityNotExists'] },
          { parent: 'Project.patch_project_by_id', children: ['datamanager/DatabaseManager.session', 'projects/Project.get_project_by_id', 'projects/items', 'projects/patch_data.model_dump', 'projects/setattr', 'projects/session.flush'] },
          { parent: 'Project.get_project_list_by_account_id', children: ['datamanager/DatabaseManager.session', 'projects/where', 'projects/select', 'projects/session.execute', 'projects/all', 'projects/result.scalars', 'projects/len'] },
          { parent: 'Project.delete_project', children: ['datamanager/DatabaseManager.session', 'projects/Project.get_project_by_id', 'projects/session.delete'] },
          { parent: 'get_account', children: ['account_endpoints/Depends', 'account_endpoints/Depends', 'account_endpoints/Depends', 'account_endpoints/log.info', 'auth_service/AuthService.verify_token', 'account_service/AccountService.get_account_by_id', 'account_endpoints/log.info', 'account_endpoints/router.get'] },
          { parent: 'patch_account', children: ['account_endpoints/Depends', 'account_endpoints/Depends', 'account_endpoints/Depends', 'account_endpoints/log.info', 'auth_service/AuthService.verify_token', 'account_service/AccountService.patch_account_by_id', 'account_endpoints/log.info', 'account_endpoints/router.patch'] },
          { parent: 'login', children: ['auth_endpoints/Depends', 'auth_endpoints/log.info', 'auth_service/AuthService.login', 'auth_endpoints/log.info', 'auth_endpoints/router.post'] },
          { parent: 'refresh', children: ['auth_endpoints/Depends', 'auth_endpoints/log.info', 'auth_service/AuthService.refresh', 'auth_endpoints/log.info', 'auth_endpoints/router.post'] },
          { parent: 'registration', children: ['auth_endpoints/Depends', 'auth_endpoints/log.info', 'auth_service/AuthService.registration', 'auth_endpoints/log.info', 'auth_endpoints/router.post'] },
          { parent: 'homepage', children: ['core_endpoints/Depends', 'core_endpoints/Depends', 'core_endpoints/Depends', 'core_endpoints/log.info', 'auth_service/AuthService.verify_token', 'core_service/CoreService.get_homepage', 'core_endpoints/log.info', 'core_endpoints/router.get'] },
          { parent: 'get_project', children: ['project_endpoints/Depends', 'project_endpoints/Depends', 'project_endpoints/Depends', 'project_endpoints/log.info', 'auth_service/AuthService.verify_token', 'project_service/ProjectService.get_project_by_id', 'project_endpoints/log.info', 'project_endpoints/router.get'] },
          { parent: 'create_project', children: ['project_endpoints/File', 'project_endpoints/Depends', 'project_endpoints/Depends', 'project_endpoints/Depends', 'project_endpoints/log.info', 'auth_service/AuthService.verify_token', 'project_service/ProjectService.create_project', 'project_endpoints/ProjectCreateData', 'project_endpoints/log.info', 'project_endpoints/router.post'] },
          { parent: 'patch_project', children: ['project_endpoints/Depends', 'project_endpoints/Depends', 'project_endpoints/Depends', 'project_endpoints/log.info', 'auth_service/AuthService.verify_token', 'project_service/ProjectService.update_project', 'project_endpoints/log.info', 'project_endpoints/router.patch'] },
          { parent: 'delete_project', children: ['project_endpoints/Depends', 'project_endpoints/Depends', 'project_endpoints/Depends', 'project_endpoints/log.info', 'auth_service/AuthService.verify_token', 'project_service/ProjectService.delete_project', 'project_endpoints/log.info', 'project_endpoints/router.delete'] },
          { parent: 'get_projects_list', children: ['project_endpoints/Depends', 'project_endpoints/Depends', 'project_endpoints/Depends', 'project_endpoints/log.info', 'auth_service/AuthService.verify_token', 'project_service/ProjectService.get_projects_by_account_id', 'project_endpoints/log.info', 'project_endpoints/router.get'] },
          { parent: 'lifespan', children: ['datamanager/DatabaseManager.init_models', 'manager/ConnectionBrokerManager.connect', 'datamanager/DatabaseManager.close', 'datamanager/DatabaseManager.close'] },
          { parent: 'TaskSession.__init__', children: ['core_server/asyncio.Queue'] },
          { parent: 'TaskSession.add_message', children: ['core_server/self.message_queue.put'] },
          { parent: 'TaskSession.get_next_message', children: ['core_server/self.message_queue.get'] },
          { parent: 'TaskSession.close', children: [] },
          { parent: 'TaskManager.__init__', children: [] },
          { parent: 'TaskManager.get_or_create_session', children: ['core_server/TaskSession'] },
          { parent: 'TaskManager.remove_session', children: [] },
          { parent: 'FrontendStreamService.__init__', children: [] },
          { parent: 'FrontendStreamService.RunAlgorithm', children: ['core_pb2_grpc/grpc.experimental.unary_stream'] },
          { parent: 'AlgorithmConnectionService.__init__', children: [] },
          { parent: 'AlgorithmConnectionService.ConnectToCore', children: ['algorithm_pb2_grpc/grpc.experimental.stream_unary'] },
          { parent: 'CoreServer.__init__', children: ['core_server/TaskManager', 'core_server/FrontendStreamService', 'core_server/AlgorithmConnectionService', 'core_server/grpc.aio.server', 'core_server/core_pb2_grpc.add_FrontendStreamServiceServicer_to_server', 'core_server/algorithm_pb2_grpc.add_AlgorithmConnectionServiceServicer_to_server', 'core_server/self.server.add_insecure_port'] },
          { parent: 'CoreServer.start', children: ['core_server/print', 'core_server/self.server.start', 'core_server/self.server.wait_for_termination'] },
          { parent: 'CoreServer.stop', children: ['core_server/print', 'core_server/list', 'core_server/self.task_manager.tasks.items', 'datamanager/DatabaseManager.close', 'core_server/self.task_manager.remove_session', 'core_server/self.server.stop'] },
          { parent: 'AlgorithmConnectionServiceStub.__init__', children: ['algorithm_pb2_grpc/channel.stream_unary'] },
          { parent: 'AlgorithmConnectionServiceServicer.ConnectToCore', children: ['algorithm_pb2_grpc/context.set_code', 'algorithm_pb2_grpc/context.set_details', 'algorithm_pb2_grpc/NotImplementedError'] },
          { parent: 'add_AlgorithmConnectionServiceServicer_to_server', children: ['algorithm_pb2_grpc/grpc.stream_unary_rpc_method_handler', 'algorithm_pb2_grpc/grpc.method_handlers_generic_handler', 'algorithm_pb2_grpc/server.add_generic_rpc_handlers', 'algorithm_pb2_grpc/server.add_registered_method_handlers'] },
          { parent: 'FrontendStreamServiceStub.__init__', children: ['core_pb2_grpc/channel.unary_stream'] },
          { parent: 'FrontendStreamServiceServicer.RunAlgorithm', children: ['core_pb2_grpc/context.set_code', 'core_pb2_grpc/context.set_details', 'core_pb2_grpc/NotImplementedError'] },
          { parent: 'add_FrontendStreamServiceServicer_to_server', children: ['core_pb2_grpc/grpc.unary_stream_rpc_method_handler', 'core_pb2_grpc/grpc.method_handlers_generic_handler', 'core_pb2_grpc/server.add_generic_rpc_handlers', 'core_pb2_grpc/server.add_registered_method_handlers'] },
          { parent: 'Consumer.__init__', children: [] },
          { parent: 'Consumer.start', children: ['consumer/self.connection.connect', 'consumer/self.connection.channel.declare_queue', 'consumer/log.info', 'consumer/self.connection.channel.set_qos', 'consumer/log.info', 'consumer/wait', 'consumer/asyncio.Event', 'consumer/log.info'] },
          { parent: 'Consumer.messages', children: ['consumer/RuntimeError', 'consumer/self.queue.iterator', 'consumer/message.process', 'consumer/json.loads', 'consumer/log.info', 'consumer/log.error'] },
          { parent: 'ConnectionBrokerManager.__init__', children: [] },
          { parent: 'ConnectionBrokerManager.connect', children: ['manager/aio_pika.connect_robust', 'manager/self.connection.channel', 'manager/self.channel.declare_exchange', 'manager/log.info', 'manager/ConnectionBrokerManager._create_queue', 'manager/ConnectionBrokerManager._bind_exchange_as_queue'] },
          { parent: 'ConnectionBrokerManager.close', children: ['manager/self.connection.close', 'manager/log.info'] },
          { parent: 'ConnectionBrokerManager._create_queue', children: ['manager/self.channel.declare_queue', 'manager/log.info'] },
          { parent: 'ConnectionBrokerManager._bind_exchange_as_queue', children: ['manager/queue.bind', 'manager/log.info'] },
          { parent: 'Producer.__init__', children: [] },
          { parent: 'Producer.publish', children: ['producer/encode', 'producer/json.dumps', 'producer/aio_pika.Message', 'producer/self.connection.exchange.publish', 'producer/log.info'] },
          { parent: 'AbstractStorage.upload_fileobj', children: [] },
          { parent: 'AbstractStorage.delete_file', children: [] },
          { parent: 'ObjectStorageManager.__init__', children: ['s3_manager/boto3.session.Session', 's3_manager/session.client'] },
          { parent: 'ObjectStorageManager.upload_fileobj', children: ['s3_manager/run_in_threadpool', 's3_manager/log.info', 's3_manager/log.error'] },
          { parent: 'ObjectStorageManager.delete_file', children: ['s3_manager/run_in_threadpool', 's3_manager/log.info', 's3_manager/log.error'] },
          { parent: 'AccountService.get_account_by_id', children: ['accounts/Account.get_account_by_id', 'account_service/AccountFullData.model_validate', 'account_service/log.error', 'account_service/HTTPException', 'account_service/log.error', 'account_service/type', 'account_service/str', 'account_service/HTTPException', 'account_service/type', 'account_service/str'] },
          { parent: 'AccountService.patch_account_by_id', children: ['accounts/Account.patch_account_by_id', 'account_service/AccountFullData.model_validate', 'account_service/log.error', 'account_service/HTTPException', 'account_service/log.error', 'account_service/type', 'account_service/str', 'account_service/HTTPException', 'account_service/type', 'account_service/str'] },
          { parent: 'AuthService.registration', children: ['auth_service/AuthService.hash_password', 'accounts/Account.is_login_exists', 'auth_service/log.error', 'auth_service/HTTPException', 'accounts/Account.create_account', 'auth_service/AccountCreateData', 'auth_service/log.error', 'auth_service/type', 'auth_service/str', 'auth_service/HTTPException', 'auth_service/type', 'auth_service/str', 'auth_service/AccountData.model_validate'] },
          { parent: 'AuthService.verify_token', children: ['auth_service/AuthService.check_access_token', 'auth_service/log.error', 'auth_service/HTTPException', 'auth_service/log.error', 'auth_service/type', 'auth_service/str', 'auth_service/HTTPException', 'auth_service/type', 'auth_service/str'] },
          { parent: 'AuthService.check_access_token', children: ['auth_service/AuthService.decode_token', 'auth_service/datetime.now', 'auth_service/HTTPException'] },
          { parent: 'AuthService.login', children: ['accounts/Account.get_account_by_login', 'auth_service/AuthService.verify_password', 'auth_service/AccountData', 'auth_service/AuthService.encode_to_token', 'auth_service/AuthService.encode_to_token', 'auth_service/log.error', 'auth_service/HTTPException', 'auth_service/log.error', 'auth_service/type', 'auth_service/str', 'auth_service/HTTPException', 'auth_service/type', 'auth_service/str', 'auth_service/AuthResponseData'] },
          { parent: 'AuthService.refresh', children: ['auth_service/AuthService.decode_token', 'auth_service/datetime.now', 'auth_service/log.error', 'auth_service/HTTPException', 'accounts/Account.get_account_by_id', 'auth_service/HTTPException', 'auth_service/AccountData', 'auth_service/AuthService.encode_to_token', 'auth_service/AuthService.encode_to_token', 'auth_service/log.error', 'auth_service/HTTPException', 'auth_service/log.error', 'auth_service/type', 'auth_service/str', 'auth_service/HTTPException', 'auth_service/type', 'auth_service/str', 'auth_service/AuthResponseData'] },
          { parent: 'AuthService.encode_to_token', children: ['auth_service/datetime.now', 'auth_service/timedelta', 'auth_service/data.model_dump', 'auth_service/start_date.isoformat', 'auth_service/end_date.isoformat', 'auth_service/JWT.encode'] },
          { parent: 'AuthService.decode_token', children: ['auth_service/JWT.decode', 'auth_service/AccountEncodeData', 'auth_service/datetime.fromisoformat', 'auth_service/datetime.fromisoformat'] },
          { parent: 'AuthService.hash_password', children: ['auth_service/bcrypt.gensalt', 'auth_service/bcrypt.hashpw', 'auth_service/password.encode', 'auth_service/hashed.decode'] },
          { parent: 'AuthService.verify_password', children: ['auth_service/bcrypt.checkpw', 'auth_service/password.encode', 'auth_service/hashed_password.encode', 'auth_service/log.error', 'auth_service/HTTPException'] },
          { parent: 'CoreService.get_homepage', children: ['accounts/Account.get_account_by_id', 'core_service/AccountData.model_validate', 'projects/Project.get_project_list_by_account_id', 'core_service/ProjectDataLite.model_validate', 'core_service/ProjectListDataLite', 'core_service/HomePageData', 'core_service/log.error', 'core_service/type', 'core_service/str', 'core_service/HTTPException', 'core_service/type', 'core_service/str'] },
          { parent: 'ProjectService.get_project_by_id', children: ['projects/Project.get_project_by_id', 'project_service/ArchitectureModel', 'project_service/ProjectData', 'project_service/log.error', 'project_service/HTTPException', 'project_service/log.error', 'project_service/type', 'project_service/str', 'project_service/HTTPException', 'project_service/type', 'project_service/str'] },
          { parent: 'ProjectService.create_project', children: ['projects/Project.create_project', 'project_service/ArchitectureModel', 'project_service/ProjectData', 'project_service/log.error', 'project_service/type', 'project_service/str', 'project_service/HTTPException', 'project_service/type', 'project_service/str'] },
          { parent: 'ProjectService.update_project', children: ['projects/Project.patch_project_by_id', 'project_service/ArchitectureModel', 'project_service/ProjectData', 'project_service/log.error', 'project_service/HTTPException', 'project_service/log.error', 'project_service/type', 'project_service/str', 'project_service/HTTPException', 'project_service/type', 'project_service/str'] },
          { parent: 'ProjectService.delete_project', children: ['projects/Project.delete_project', 'project_service/log.error', 'project_service/HTTPException', 'project_service/log.error', 'project_service/type', 'project_service/str', 'project_service/HTTPException', 'project_service/type', 'project_service/str'] },
          { parent: 'ProjectService.get_projects_by_account_id', children: ['projects/Project.get_project_list_by_account_id', 'project_service/ProjectDataLite.model_validate', 'project_service/ProjectListDataLite', 'project_service/log.error', 'project_service/type', 'project_service/str', 'project_service/HTTPException', 'project_service/type', 'project_service/str'] },
          { parent: 'TaskService.add_task', children: [] },
          { parent: 'load_config', children: ['config/Config', 'config/ConfigAuth', 'config/os.environ.get', 'config/int', 'config/int', 'config/ConfigServer', 'config/os.environ.get', 'config/int', 'config/os.environ.get', 'config/ConfigDB', 'config/os.environ.get', 'config/int', 'config/os.environ.get', 'config/lower', 'config/os.environ.get', 'config/ConfigBroker', 'config/os.environ.get', 'config/os.environ.get', 'config/os.environ.get', 'config/os.environ.get'] },
          { parent: 'create_logger', children: ['logger/logging.getLogger', 'logger/setLevel', 'logger/logging.Formatter', 'logger/logging.StreamHandler', 'logger/console_handler.setFormatter', 'logger/logger.addHandler'] }
        ]
      };

      // 1. Requirements
      await new Promise(r => setTimeout(r, 500));
      if (cancelled) return;
      console.log('üì¶ –ó–∞–≥—Ä—É–∂–∞–µ–º requirements');
      setRequirements(mockData.requirements);
      setStreamStatus('streaming');
      setProgress({ total: 100, current: 10 });

      // 2. Endpoints
      await new Promise(r => setTimeout(r, 500));
      if (cancelled) return;
      console.log('üåê –ó–∞–≥—Ä—É–∂–∞–µ–º endpoints');
      setEndpoints(mockData.endpoints);
      setProgress({ total: 100, current: 15 });

      // 3. Architecture (–ø–æ —á–∞—Å—Ç—è–º, –∫–∞–∫ —Å—Ç—Ä–∏–º)
      console.log(`üèóÔ∏è –ó–∞–≥—Ä—É–∂–∞–µ–º –∞—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä—É (${mockData.architecture.length} —ç–ª–µ–º–µ–Ω—Ç–æ–≤)...`);
      for (let i = 0; i < mockData.architecture.length; i++) {
        await new Promise(r => setTimeout(r, 100));
        if (cancelled) return;
        
        setArchitecture(prev => [...prev, mockData.architecture[i]]);
        
        const progressPercent = 15 + Math.floor((i / mockData.architecture.length) * 80);
        setProgress({ total: 100, current: progressPercent });
      }

      if (cancelled) return;
      console.log('‚úÖ –í—Å–µ –¥–∞–Ω–Ω—ã–µ –∑–∞–≥—Ä—É–∂–µ–Ω—ã!');
      setStreamStatus('done');
      setProgress({ total: 100, current: 100 });
    };

    _simulateStream();

    return () => {
      cancelled = true;
    };
  }, [id]);

  // Group endpoints by service/class
  const endpointsByService = useMemo(() => {
    const grouped = {};
    Object.entries(endpoints).forEach(([route, handler]) => {
      // Parse handler: "file/ClassName.method_name" or just "ClassName.method_name"
      const parts = handler.split('/');
      const lastPart = parts[parts.length - 1];
      const className = lastPart.split('.')[0];
      
      // Skip Health endpoints, main, and database-related
      if (className === 'Health' || 
          className === 'main' || 
          className === 'DataManager' || 
          className === 'DatabaseManager' ||
          lastPart.includes('database')) {
        return;
      }
      
      if (!className) return;
      if (!grouped[className]) {
        grouped[className] = [];
      }
      grouped[className].push({ route, handler });
    });
    return grouped;
  }, [endpoints]);

  // Build graph incrementally from architecture data
  useEffect(() => {
    if (architecture.length === 0) return;

    // –û–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ–º —Ç–æ–ª—å–∫–æ –ø–æ—Å–ª–µ–¥–Ω–∏–π —ç–ª–µ–º–µ–Ω—Ç (–Ω–æ–≤—ã–π)
    const lastArch = architecture[architecture.length - 1];
    
    const parts = lastArch.parent.split('/');
    const lastPart = parts[parts.length - 1];
    const [className, methodName] = lastPart.split('.');
    
    // Skip specific classes
    if (className === 'Health' || 
        className === 'main' || 
        className === 'DataManager' || 
        className === 'DatabaseManager' ||
        lastPart.includes('_main_') ||
        lastPart.includes('database')) {
      return;
    }
    
    if (!className) return;
    
    // –û–±–Ω–æ–≤–ª—è–µ–º serviceMap –∏–Ω–∫—Ä–µ–º–µ–Ω—Ç–∞–ª—å–Ω–æ
    setServiceMap(prevServiceMap => {
      const newServiceMap = new Map(prevServiceMap);
      
      if (!newServiceMap.has(className)) {
        newServiceMap.set(className, {
          methods: [],
          dependencies: new Set()
        });
      }
      
      const service = newServiceMap.get(className);
      service.methods.push({ method: methodName || lastPart, children: lastArch.children });
      
      // Track dependencies
      lastArch.children.forEach(child => {
        const childParts = child.split('/');
        const childLastPart = childParts[childParts.length - 1];
        const depClass = childLastPart.split('.')[0];
        
        // Skip database and main dependencies
        if (depClass && depClass !== className && 
            depClass !== 'DataManager' && 
            depClass !== 'DatabaseManager' &&
            depClass !== 'main' &&
            !childLastPart.includes('database')) {
          service.dependencies.add(depClass);
        }
      });
      
      return newServiceMap;
    });
  }, [architecture]);
  
  // –û—Ç–¥–µ–ª—å–Ω—ã–π useEffect –¥–ª—è –ø–µ—Ä–µ—Å—Ç—Ä–æ–µ–Ω–∏—è –≥—Ä–∞—Ñ–∞ –∫–æ–≥–¥–∞ serviceMap –æ–±–Ω–æ–≤–ª—è–µ—Ç—Å—è
  useEffect(() => {
    if (serviceMap.size === 0) return;
    
    const newNodes = [];
    const newEdges = [];
    const nodeMap = new Map();
    
    const LAYER_WIDTH = 450;
    const NODE_HEIGHT = 100;
    const VERTICAL_SPACING = 120;
    const START_X = 100;
    const START_Y = 100;

    // Determine layers for left-to-right layout
    const layers = new Map();
    const assignLayer = (serviceName, layer = 0) => {
      if (layers.has(serviceName)) return;
      layers.set(serviceName, layer);
      
      const service = serviceMap.get(serviceName);
      if (service && service.dependencies.size > 0) {
        service.dependencies.forEach(dep => {
          if (serviceMap.has(dep)) {
            assignLayer(dep, layer + 1);
          }
        });
      }
    };

    // Assign layers
    serviceMap.forEach((_, serviceName) => assignLayer(serviceName));

    // Sort services by layer
    const layerGroups = new Map();
    layers.forEach((layer, serviceName) => {
      if (!layerGroups.has(layer)) {
        layerGroups.set(layer, []);
      }
      layerGroups.get(layer).push(serviceName);
    });

    // Create nodes for each service
    layerGroups.forEach((services, layer) => {
      services.forEach((serviceName, index) => {
        const service = serviceMap.get(serviceName);
        const x = START_X + layer * LAYER_WIDTH;
        const y = START_Y + index * (NODE_HEIGHT + VERTICAL_SPACING);
        
        const nodeIdStr = `service_${serviceName}`;
        
        const node = {
          id: nodeIdStr,
          type: 'default',
          position: { x, y },
          data: { 
            label: (
              <NodeContent 
                serviceName={serviceName} 
                methodCount={service.methods.length}
              />
            ),
            serviceName,
            methodCount: service.methods.length,
          },
          style: {
            background: getServiceColor(serviceName),
            border: 'none',
            borderRadius: '12px',
            padding: '16px 20px',
            minWidth: '240px',
            boxShadow: '0 4px 12px rgba(0,0,0,0.15)',
          },
        };

        newNodes.push(node);
        nodeMap.set(serviceName, nodeIdStr);
      });
    });

    // Create edges between services
    const edgeSet = new Set();
    serviceMap.forEach((service, sourceName) => {
      const sourceId = nodeMap.get(sourceName);
      if (!sourceId) return;
      
      service.dependencies.forEach(targetName => {
        const targetId = nodeMap.get(targetName);
        if (!targetId) return;
        
        const edgeKey = `${sourceId}-${targetId}`;
        if (edgeSet.has(edgeKey)) return;
        edgeSet.add(edgeKey);
        
        newEdges.push({
          id: edgeKey,
          source: sourceId,
          target: targetId,
          type: 'smoothstep',
          animated: false,
          className: 'custom-edge',
          pathOptions: { offset: 20, borderRadius: 10 },
          style: { 
            stroke: '#A0A0A0', 
            strokeWidth: 2,
            strokeOpacity: 1,
          },
          markerEnd: {
            type: MarkerType.ArrowClosed,
            color: '#A0A0A0',
            width: 20,
            height: 20,
          },
        });
      });
    });

    setNodes(newNodes);
    setEdges(newEdges);
  }, [serviceMap]);

  // Update edge styles based on hovered node
  const styledEdges = useMemo(() => {
    if (!hoveredNode || edges.length === 0) return edges;

    return edges.map(edge => {
      const isConnected = edge.source === hoveredNode || edge.target === hoveredNode;
      return {
        ...edge,
        animated: isConnected,
        style: {
          stroke: isConnected ? '#5A6FD6' : '#A0A0A0',
          strokeWidth: isConnected ? 3 : 2,
          strokeOpacity: isConnected ? 1 : 0.3,
        },
        markerEnd: {
          type: MarkerType.ArrowClosed,
          color: isConnected ? '#5A6FD6' : '#A0A0A0',
          width: 20,
          height: 20,
        },
      };
    });
  }, [edges, hoveredNode]);

  // Service colors inspired by the design
  const getServiceColor = (serviceName) => {
    const colors = {
      'Account': 'linear-gradient(135deg, #5A6FD6 0%, #4A5FC6 100%)',
      'Project': 'linear-gradient(135deg, #6B8FE8 0%, #5A7FD8 100%)',
      'DatabaseManager': 'linear-gradient(135deg, #7BA3F2 0%, #6B93E2 100%)',
      'Core': 'linear-gradient(135deg, #8BB7FC 0%, #7BA7EC 100%)',
    };
    
    return colors[serviceName] || 'linear-gradient(135deg, #F4F6FF 0%, #E4E6EF 100%)';
  };

  // Handle node click
  const onNodeClick = useCallback((event, node) => {
    setSelectedNode(node);
  }, []);

  const onPaneClick = useCallback(() => {
    setSelectedNode(null);
  }, []);

  // Handle node hover for edge highlighting
  const onNodeMouseEnter = useCallback((event, node) => {
    setHoveredNode(node.id);
  }, []);

  const onNodeMouseLeave = useCallback(() => {
    setHoveredNode(null);
  }, []);

  return (
    <div className={styles.container}>
      {/* Header */}
      <header className={styles.header}>
        <button onClick={() => navigate('/projects')} className={styles.backBtn}>
          ‚Üê –ù–∞–∑–∞–¥ –∫ –ø—Ä–æ–µ–∫—Ç–∞–º
        </button>
        <div className={styles.projectInfo}>
          <h1>Project #{id} - Architecture Visualization</h1>
          <div className={styles.statusBadge}>
            {streamStatus === 'loading' && 'üîÑ Initializing...'}
            {streamStatus === 'streaming' && 'üîÑ Receiving data...'}
            {streamStatus === 'done' && '‚úÖ Complete'}
            {streamStatus === 'connecting' && '‚è≥ Connecting...'}
            {streamStatus === 'error' && '‚ùå Error'}
          </div>
        </div>
        <div className={styles.stats}>
          <div className={styles.stat}>
            <span className={styles.statValue}>
              {progress.total > 0 ? Math.round((progress.current / progress.total) * 100) : 0}%
            </span>
            <span className={styles.statLabel}>Progress</span>
          </div>
          <div className={styles.stat}>
            <span className={styles.statValue}>{nodes.length}</span>
            <span className={styles.statLabel}>Services</span>
          </div>
          <div className={styles.stat}>
            <span className={styles.statValue}>{edges.length}</span>
            <span className={styles.statLabel}>Connections</span>
          </div>
        </div>
      </header>

      {/* Main Content */}
      <div className={styles.content}>
        {/* Requirements Panel */}
        <aside className={styles.sidebar}>
          <div className={styles.sidebarHeader}>
            <h3>üì¶ Requirements</h3>
          </div>
          <div className={styles.sidebarContent}>
            {requirements.length === 0 ? (
              <p className={styles.emptyState}>‚è≥ Loading requirements...</p>
            ) : (
              <div className={styles.requirementsList}>
                {requirements.map((req, i) => (
                  <div key={i} className={styles.requirementItem}>
                    <span className={styles.reqIcon}>üì¶</span>
                    <span className={styles.reqName}>{req}</span>
                  </div>
                ))}
              </div>
            )}
          </div>
        </aside>

        {/* Graph Visualization */}
        <main className={styles.mainContent}>
          {/* Loading State - show when loading or connecting without data */}
          {(streamStatus === 'connecting' || streamStatus === 'loading') && nodes.length === 0 && requirements.length === 0 && Object.keys(endpoints).length === 0 && (
            <div className={styles.loadingContainer}>
              <div className={styles.loadingSpinner}></div>
              <h2>–ê–Ω–∞–ª–∏–∑ –∞—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä—ã –ø—Ä–æ–µ–∫—Ç–∞...</h2>
              <p>–ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –ø–æ–¥–æ–∂–¥–∏—Ç–µ. –î–∞–Ω–Ω—ã–µ –∑–∞–≥—Ä—É–∂–∞—é—Ç—Å—è...</p>
              <div className={styles.progressBar}>
                <div 
                  className={styles.progressFill} 
                  style={{ width: `${progress.total > 0 ? Math.round((progress.current / progress.total) * 100) : 0}%` }}
                ></div>
              </div>
            </div>
          )}

          {/* Graph Visualization - show as soon as we have data */}
          {(requirements.length > 0 || Object.keys(endpoints).length > 0 || nodes.length > 0) && (
            <div className={styles.flowWrapper}>
              <ReactFlow
              nodes={nodes}
              edges={styledEdges}
              onNodesChange={onNodesChange}
              onEdgesChange={onEdgesChange}
              onNodeClick={onNodeClick}
              onPaneClick={onPaneClick}
              onNodeMouseEnter={onNodeMouseEnter}
              onNodeMouseLeave={onNodeMouseLeave}
              fitView
              fitViewOptions={{ padding: 0.3, maxZoom: 1 }}
              minZoom={0.1}
              maxZoom={2}
              proOptions={{ hideAttribution: true }}
              elementsSelectable={true}
              nodesConnectable={false}
              nodesDraggable={true}
              zoomOnScroll={true}
              panOnScroll={false}
              preventScrolling={true}
              zoomOnDoubleClick={false}
              selectNodesOnDrag={false}
              connectionLineType="smoothstep"
              defaultEdgeOptions={{
                type: 'smoothstep',
                pathOptions: { offset: 20, borderRadius: 10 }
              }}
            >
              <Background color="#E0E0E0" gap={20} size={1} />
              <Controls className={styles.controls} />
              <MiniMap
                nodeColor={(node) => {
                  const serviceName = node.data?.serviceName || '';
                  if (serviceName.includes('Account')) return '#5A6FD6';
                  if (serviceName.includes('Project')) return '#6B8FE8';
                  if (serviceName.includes('Database')) return '#7BA3F2';
                  if (serviceName.includes('Core')) return '#8BB7FC';
                  return '#D0D4F0';
                }}
                className={styles.minimap}
              />
              
              {/* Legend Panel */}
              <Panel position="top-right" className={styles.legendPanel}>
                <div className={styles.legend}>
                  <h4>Legend</h4>
                  <div className={styles.legendItem}>
                    <div className={styles.legendColor} style={{ background: '#5A6FD6' }}></div>
                    <span>Account</span>
                  </div>
                  <div className={styles.legendItem}>
                    <div className={styles.legendColor} style={{ background: '#6B8FE8' }}></div>
                    <span>Project</span>
                  </div>
                  <div className={styles.legendItem}>
                    <div className={styles.legendColor} style={{ background: '#7BA3F2' }}></div>
                    <span>Database</span>
                  </div>
                  <div className={styles.legendItem}>
                    <div className={styles.legendColor} style={{ background: '#8BB7FC' }}></div>
                    <span>Core</span>
                  </div>
                </div>
              </Panel>

              {/* Endpoints Panel */}
              <Panel position="bottom-left" className={styles.endpointsPanel}>
                <div className={styles.endpoints}>
                  <h4>üåê API Endpoints</h4>
                  {Object.keys(endpointsByService).length === 0 ? (
                    <p className={styles.emptyState}>‚è≥ Loading endpoints...</p>
                  ) : (
                    <div className={styles.endpointsList}>
                      {Object.entries(endpointsByService).map(([serviceName, eps]) => (
                        <div key={serviceName} className={styles.endpointGroup}>
                          <div className={styles.endpointServiceName}>{serviceName}</div>
                          {eps.slice(0, 3).map((ep, idx) => {
                            const [method, path] = ep.route.split(' ');
                            return (
                              <div key={idx} className={styles.endpointItem}>
                                <span className={`${styles.httpMethod} ${styles[method?.toLowerCase()]}`}>
                                  {method}
                                </span>
                                <span className={styles.endpointPath}>{path}</span>
                              </div>
                            );
                          })}
                          {eps.length > 3 && (
                            <div className={styles.endpointMore}>
                              +{eps.length - 3} more
                            </div>
                          )}
                        </div>
                      ))}
                    </div>
                  )}
                </div>
              </Panel>
            </ReactFlow>
            </div>
          )}
        </main>
      </div>

      {/* Node Details Modal */}
      {selectedNode && (
        <div className={styles.detailsModal} onClick={() => setSelectedNode(null)}>
          <div className={styles.detailsContent} onClick={(e) => e.stopPropagation()}>
            <div className={styles.detailsHeader}>
              <h3>{selectedNode.data.serviceName}</h3>
              <button onClick={() => setSelectedNode(null)}>‚úï</button>
            </div>
            <div className={styles.detailsBody}>
              <div className={styles.detailItem}>
                <span className={styles.detailLabel}>Service:</span>
                <span className={styles.detailValue}>{selectedNode.data.serviceName}</span>
              </div>
              <div className={styles.detailItem}>
                <span className={styles.detailLabel}>Methods:</span>
                <span className={styles.detailValue}>{selectedNode.data.methodCount}</span>
              </div>
              <div className={styles.detailItem}>
                <span className={styles.detailLabel}>Dependencies:</span>
                <span className={styles.detailValue}>
                  {edges.filter(e => e.source === selectedNode.id).length}
                </span>
              </div>
              <div className={styles.detailItem}>
                <span className={styles.detailLabel}>Used by:</span>
                <span className={styles.detailValue}>
                  {edges.filter(e => e.target === selectedNode.id).length}
                </span>
              </div>
            </div>
          </div>
        </div>
      )}
    </div>
  );
}
